<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helix Focus Controller</title>
    <style>
        body { 
            color: #e0e0e0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin: 0; 
            overflow: hidden;
            
            /* --- FONDO CON IMAGEN --- */
            /* El color de fondo original se usa como fallback */
            background-color: #121212; 
            /* Puedes cambiar la URL por la imagen que quieras */
            background-image: linear-gradient(rgba(18, 18, 18, 0.85), rgba(18, 18, 18, 0.85)), url('https://www.svgrepo.com/show/506934/grid-plus.svg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        h2 { margin: 10px 0; color: #ff5722; }
        
        /* Controles de carga */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        .file-btn { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; }
        .file-btn.loaded { background-color: #004d40; border-color: #00e676; }
        input[type="file"] { display: none; }
        
        /* El Pad XY */
        #pad-container {
            width: 90vw; height: 50vh; margin: 10px auto;
            background: radial-gradient(circle, #2c2c2c 0%, #1a1a1a 100%);
            border: 2px solid #ff5722; border-radius: 12px;
            position: relative; touch-action: none; /* Crucial para mÃ³viles */
        }
        #cursor {
            width: 30px; height: 30px; background: rgba(255, 87, 34, 0.8);
            border: 2px solid #fff; border-radius: 50%;
            position: absolute; transform: translate(-50%, -50%);
            top: 50%; left: 50%; box-shadow: 0 0 15px #ff5722;
        }

        /* Monitor de datos */
        #status { font-family: monospace; font-size: 0.9rem; color: #00e676; margin-top: 10px; white-space: pre-wrap; height: 100px; overflow-y: auto; }
        
        /* BotÃ³n Conectar */
        #connect-btn { background: #00e676; color: black; border: none; padding: 10px 20px; font-weight: bold; border-radius: 20px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>Helix Focus View</h2>
    <button id="connect-btn" onclick="initMIDI()">ðŸ”Œ Conectar USB MIDI</button>

    <div class="controls">
        <label class="file-btn">ðŸ“‚ Cargar A (Top-L)<input type="file" onchange="loadHlx(this, 'tl')"></label>
        <label class="file-btn">ðŸ“‚ Cargar B (Top-R)<input type="file" onchange="loadHlx(this, 'tr')"></label>
        <label class="file-btn">ðŸ“‚ Cargar C (Bot-L)<input type="file" onchange="loadHlx(this, 'bl')"></label>
        <label class="file-btn">ðŸ“‚ Cargar D (Bot-R)<input type="file" onchange="loadHlx(this, 'br')"></label>
    </div>

    <div id="pad-container">
        <div id="cursor"></div>
    </div>

    <div id="status">Esperando conexiÃ³n...</div>

<script>
    // --- CONFIGURACIÃ“N DE MAPEO MIDI (CC) ---
    const CC_MAP = {
        "Drive": 4,  "Bass": 5,   "Mid": 6, 
        "Treble": 7, "Presence": 8, "Master": 9,
        "ChVol": 10, "Mix": 11, "Decay": 12
    };

    let midiOut = null;
    let corners = { tl: {}, tr: {}, bl: {}, br: {} };

    document.addEventListener('DOMContentLoaded', loadSessionFromStorage);

    // 1. INICIALIZAR MIDI
    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX") || o.name.includes("Line 6"));
            
            if (!midiOut && outputs.length > 0) midiOut = outputs[0];
            
            if (midiOut) {
                document.getElementById('connect-btn').style.background = "#2196F3";
                document.getElementById('connect-btn').innerText = "âœ… " + midiOut.name;
                log("Conectado a: " + midiOut.name);
            } else {
                alert("No se encontrÃ³ pedal. AsegÃºrate de conectar el cable OTG antes de abrir Chrome.");
            }
        } catch (e) {
            alert("Error MIDI: " + e);
        }
    }

    // 2. LEER ARCHIVOS .HLX Y GUARDAR SESIÃ“N
    function loadHlx(input, key) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                const str = JSON.stringify(json);
                const params = {};
                
                Object.keys(CC_MAP).forEach(pName => {
                    const regex = new RegExp(`"${pName}":\\s*([0-9.]+)`, 'g');
                    const match = regex.exec(str);
                    if (match) params[pName] = parseFloat(match[1]);
                });

                if (Object.keys(params).length > 0) {
                    corners[key] = params;
                    // Guardar en localStorage
                    localStorage.setItem(`helixFocus_params_${key}`, JSON.stringify(params));
                    localStorage.setItem(`helixFocus_fileName_${key}`, file.name);
                    
                    updateCornerUI(key, file.name);
                    log(`Cargado ${key.toUpperCase()}: ${file.name} (${Object.keys(params).length} params)`);
                } else {
                    log(`Error: No se encontraron parÃ¡metros mapeados en ${file.name}`);
                }
            } catch (err) { 
                log("Error leyendo archivo. Â¿Es un .hlx vÃ¡lido?"); 
                updateCornerUI(key, null); // Revertir UI si falla
            }
        };
        reader.readAsText(file);
    }

    // 3. ACTUALIZAR UI DE LOS BOTONES
    function updateCornerUI(key, fileName) {
        const label = document.querySelector(`input[onchange="loadHlx(this, '${key}')"]`).parentElement;
        if (fileName) {
            label.classList.add('loaded');
            // Truncar nombre de archivo si es muy largo
            const displayName = fileName.length > 20 ? fileName.substring(0, 18) + '...' : fileName;
            label.innerHTML = `âœ… ${displayName}<input type="file" onchange="loadHlx(this, '${key}')">`;
        } else {
            label.classList.remove('loaded');
            const cornerName = {tl: 'A (Top-L)', tr: 'B (Top-R)', bl: 'C (Bot-L)', br: 'D (Bot-R)'}[key];
            label.innerHTML = `ðŸ“‚ Cargar ${cornerName}<input type="file" onchange="loadHlx(this, '${key}')">`;
        }
    }

    // 4. CARGAR SESIÃ“N DESDE LOCALSTORAGE
    function loadSessionFromStorage() {
        log("Buscando sesiÃ³n guardada...");
        let found = false;
        ['tl', 'tr', 'bl', 'br'].forEach(key => {
            const paramsStr = localStorage.getItem(`helixFocus_params_${key}`);
            const fileName = localStorage.getItem(`helixFocus_fileName_${key}`);

            if (paramsStr && fileName) {
                corners[key] = JSON.parse(paramsStr);
                updateCornerUI(key, fileName);
                found = true;
            }
        });
        if (found) {
            log("SesiÃ³n anterior restaurada. Â¡Listo para tocar!");
        } else {
            log("Carga presets en las 4 esquinas para empezar.");
        }
    }

    // 5. INTERPOLACIÃ“N Y UI
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if (!e.isPrimary) return; 
        if (e.buttons === 0 && e.pointerType === 'mouse') return;
        
        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        let y = (e.clientY - rect.top) / rect.height;
        x = Math.max(0, Math.min(1, x));
        y = Math.max(0, Math.min(1, y));

        cursor.style.left = (x * 100) + '%';
        cursor.style.top = (y * 100) + '%';

        processMidi(x, y);
    });

    pad.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function processMidi(x, y) {
        if (!midiOut || Object.keys(corners.tl).length === 0) return;

        let logStr = "";
        
        Object.keys(corners.tl).forEach(param => {
            if (CC_MAP[param]) {
                const vTL = corners.tl[param] || 0;
                const vTR = corners.tr[param] || vTL;
                const vBL = corners.bl[param] || vTL;
                const vBR = corners.br[param] || vTL;

                const top = vTL + (vTR - vTL) * x;
                const bottom = vBL + (vBR - vBL) * x;
                const val = top + (bottom - top) * y;

                const midiVal = Math.min(127, Math.max(0, Math.floor(val * 127)));
                
                midiOut.send([0xB0, CC_MAP[param], midiVal]);
                
                logStr += `${param}: ${midiVal} \n`;
            }
        });
        document.getElementById('status').innerText = logStr;
    }

    function log(msg) { document.getElementById('status').innerText = msg; }
</script>
</body>
</html>