<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helix Focus - Auto Mode</title>
    <style>
        body { 
            background-color: #121212; color: #fff; 
            font-family: sans-serif; text-align: center; margin: 0; overflow: hidden;
        }
        
        /* Joystick que brilla */
        #pad-container {
            width: 90vw; height: 50vh; margin: 20px auto;
            background: radial-gradient(circle, #333 0%, #000 100%);
            border: 2px solid #ff5722; border-radius: 15px;
            position: relative; touch-action: none;
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.3);
        }
        #cursor {
            width: 50px; height: 50px; background: rgba(255, 87, 34, 0.6);
            border: 3px solid #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Botones */
        .btn { 
            padding: 15px; border-radius: 10px; border: none; 
            font-weight: bold; margin: 5px; cursor: pointer; width: 90%;
            font-size: 1rem;
        }
        .btn-connect { background: #00e676; color: #000; }
        .btn-file { background: #37474f; color: #fff; border: 1px solid #546e7a; position: relative;}
        .btn-file.loaded { background: #2e7d32; border-color: #66bb6a; }
        
        input[type="file"] { display: none; }
        
        /* Texto de estado */
        #status { font-family: monospace; color: #69f0ae; margin-top: 10px; white-space: pre; }
    </style>
</head>
<body>

    <h2 style="color:#ff5722">MODO AUTO-VARIACIÃ“N</h2>
    
    <button class="btn btn-connect" id="btn-con" onclick="initMIDI()">ðŸ”Œ 1. CONECTAR USB</button>
    
    <label class="btn btn-file" id="lbl-file">
        ðŸ“‚ 2. CARGAR PRESET BASE
        <input type="file" onchange="loadFile(this)">
    </label>

    <div id="pad-container">
        <div id="cursor"></div>
    </div>

    <div id="status">Esperando...</div>

<script>
    const CC_MAP = { "Drive": 4, "Bass": 5, "Mid": 6, "Treble": 7, "Presence": 8, "Master": 9 };
    let midiOut = null;
    let baseParams = {}; // AquÃ­ guardamos tu archivo

    // 1. MIDI
    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX")) || outputs[0];
            if(midiOut) document.getElementById('btn-con').innerText = "âœ… " + midiOut.name;
        } catch(e) { alert(e); }
    }

    // 2. LEER ARCHIVO
    function loadFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const txt = e.target.result;
            // Buscamos los parÃ¡metros
            Object.keys(CC_MAP).forEach(k => {
                // Truco: Buscamos "Drive": 4.5  en el texto del archivo
                const regex = new RegExp(`"${k}":\\s*([0-9.]+)`);
                const match = regex.exec(txt);
                if(match) baseParams[k] = parseFloat(match[1]);
            });

            if(Object.keys(baseParams).length > 0) {
                document.getElementById('lbl-file').classList.add('loaded');
                document.getElementById('lbl-file').innerHTML = `âœ… LISTO: ${file.name}`;
                document.getElementById('status').innerText = "Izquierda = Original \nDerecha = AUTO-TURBO (+Drive +Mid)";
            } else {
                alert("Error: No encontrÃ© parÃ¡metros 'Drive' o 'Bass' en este archivo.");
            }
        };
        reader.readAsText(file);
    }

    // 3. EL JOYSTICK "MÃGICO"
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if(!e.isPrimary) return;
        if(e.pointerType === 'mouse' && e.buttons === 0) return; // Click necesario en PC

        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        x = Math.max(0, Math.min(1, x)); // 0 a 1

        // Mover visualmente solo en Horizontal (X) para simplificar
        cursor.style.left = (x * 100) + '%';
        
        sendMidi(x);
    });

    function sendMidi(x) {
        if(Object.keys(baseParams).length === 0) return;
        
        let msg = "";

        Object.keys(baseParams).forEach(key => {
            if(CC_MAP[key]) {
                const startVal = baseParams[key];
                let endVal = startVal;

                // --- AQUÃ ESTÃ LA MAGIA ---
                // Si movemos a la derecha, el cÃ³digo INVENTA valores nuevos
                if(key === "Drive") endVal = 10.0;   // El Drive siempre subirÃ¡ al mÃ¡ximo
                if(key === "Mid") endVal = 10.0;     // Los Medios subirÃ¡n
                if(key === "Bass") endVal = startVal * 0.5; // Los Bajos bajarÃ¡n a la mitad
                
                // Calculamos el punto intermedio
                const current = startVal + (endVal - startVal) * x;
                
                // Convertir a MIDI 0-127
                // (La Helix usa internamente 0.0-10.0 para amps, asÃ­ que multiplicamos por 12.7)
                // Si tu archivo usa valores 0.0-1.0, ajusta aquÃ­.
                let midiVal = Math.floor(current * 12.7); 
                if(midiVal > 127) midiVal = 127;

                if(midiOut) midiOut.send([0xB0, CC_MAP[key], midiVal]);
                msg += `${key}: ${midiVal} `;
            }
        });
        document.getElementById('status').innerText = msg;
    }
</script>
</body>
</html>
