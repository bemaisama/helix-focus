<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Helix Focus</title>
    <style>
        /* --- ESTILO GENERAL (CORREGIDO PARA M√ìVIL) --- */
        body { 
            background-color: #121212; 
            color: #e0e0e0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center; 
            margin: 0; 
            padding: 0;
            
            /* TRUCO PARA M√ìVIL: */
            position: fixed; /* Evita el "rebote" de la pantalla */
            top: 0; left: 0; right: 0; bottom: 0;
            height: 100dvh; /* 'dvh' se adapta si aparecen/desaparecen las barras del navegador */
            
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Distribuye mejor el espacio vertical */
            overflow: hidden;
        }
        
        h2 { 
            color: #ff9800; 
            font-size: 1.1rem; 
            letter-spacing: 1px; 
            margin: 10px 0 5px 0; 
            text-transform: uppercase;
            flex-shrink: 0; 
        }

        /* --- BOTONES --- */
        .controls-area {
            width: 100%;
            display: flex;
            flex-direction: column; 
            gap: 8px;
            padding-bottom: 5px;
            align-items: center;
            flex-shrink: 0; 
            z-index: 10;
        }

        .btn { 
            padding: 10px 20px; 
            border-radius: 30px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            width: 80%; 
            max-width: 300px;
            font-size: 0.85rem; 
            transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.97); }
        
        .btn-connect { background: #00c853; color: #000; box-shadow: 0 4px 10px rgba(0, 200, 83, 0.3); }
        
        .btn-file { 
            background: #37474f; color: #eceff1; 
            border: 1px solid #546e7a;
        }
        .btn-file.loaded { 
            background: #212121; 
            border-color: #ff9800; 
            color: #ff9800;
        }
        
        input[type="file"] { display: none; }
        
        /* --- CONTENEDOR DEL JOYSTICK --- */
        #pad-wrapper {
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            /* Evita que el contenedor sea m√°s grande que el espacio disponible */
            overflow: hidden; 
        }

        #pad-container {
            /* CAMBIO CLAVE: Usamos 'vmin' en lugar de 'vw' */
            /* Esto toma el 80% del lado M√ÅS PEQUE√ëO de la pantalla (sea ancho o alto) */
            width: 75vmin; 
            height: 75vmin; 
            
            max-width: 350px; 
            max-height: 350px;
            
            background: radial-gradient(circle at center, #2c2c2c 0%, #151515 100%);
            border: 2px solid #ff9800; 
            border-radius: 20px;
            position: relative; 
            touch-action: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #pad-container::after, #pad-container::before {
            content: ""; position: absolute; background: rgba(255, 152, 0, 0.1); pointer-events: none;
        }
        #pad-container::after { top: 50%; left: 10px; right: 10px; height: 1px; }
        #pad-container::before { left: 50%; top: 10px; bottom: 10px; width: 1px; }

        #cursor {
            width: 20px; height: 20px; 
            background: rgba(255, 152, 0, 0.8);
            border: 3px solid #fff; 
            border-radius: 50%;
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-20%, -20%);
            pointer-events: none; 
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.6);
            transition: width 0.1s, height 0.1s;
        }
        #pad-container:active #cursor { width: 35px; height: 35px; background: #fff; }

        /* --- MONITOR DE DATOS --- */
        #status { 
            font-family: 'Consolas', monospace; 
            color: #69f0ae; 
            font-size: 0.8rem; 
            height: 40px;
            /* Margen inferior seguro para iPhones nuevos (la barrita de home) */
            padding-bottom: env(safe-area-inset-bottom); 
            margin-bottom: 10px;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            flex-shrink: 0;
            background: rgba(0,0,0,0.2); /* Fondo suave para leer mejor */
            width: 100%;
        }
    </style>
</head>
<body>

    <h2>üéõÔ∏è Vibro-Verb Control</h2>

    <div class="controls-area">
        <button class="btn btn-connect" id="btn-con" onclick="initMIDI()">üîå Conectar HX Stomp</button>
        
        <label class="btn btn-file" id="lbl-file">
            üìÇ Cargar Archivo .hlx
            <input type="file" onchange="loadFile(this)">
        </label>
    </div>

    <div id="pad-wrapper">
        <div id="pad-container">
            <div id="cursor"></div>
        </div>
    </div>

    <div id="status">Esperando conexi√≥n...</div>

<script>
    // --- L√ìGICA INTERNA (Igual que antes) ---
    const CC_MAP = { "Drive": 4, "Bass": 5, "Mid": 6, "Treble": 7, "Presence": 8, "ChVol": 10, "Master": 9 };
    let midiOut = null;
    let baseParams = {}; 

    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX") || o.name.includes("Line 6")) || outputs[0];
            if(midiOut) {
                document.getElementById('btn-con').innerHTML = "‚úÖ <b>" + midiOut.name + "</b>";
                document.getElementById('btn-con').style.background = "#b9f6ca";
            }
        } catch(e) { alert("Error: No se detect√≥ MIDI USB"); }
    }

    function loadFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const txt = e.target.result;
            Object.keys(CC_MAP).forEach(k => {
                const regex = new RegExp(`"${k}":\\s*([0-9.]+)`);
                const match = regex.exec(txt);
                if(match) baseParams[k] = parseFloat(match[1]);
            });

            if(Object.keys(baseParams).length > 0) {
                document.getElementById('lbl-file').classList.add('loaded');
                document.getElementById('lbl-file').innerHTML = `‚úÖ ${file.name.substring(0,18)}...`;
                document.getElementById('status').innerText = "Listo para tocar";
            } else {
                alert("Error: Archivo inv√°lido o sin Amplificador.");
            }
        };
        reader.readAsText(file);
    }

    // --- JOYSTICK LOGIC ---
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if(!e.isPrimary) return;
        if(e.pointerType === 'mouse' && e.buttons === 0) return; 

        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        let y = (e.clientY - rect.top) / rect.height;
        
        x = Math.max(0, Math.min(1, x));
        y = Math.max(0, Math.min(1, y));

        cursor.style.left = (x * 100) + '%';
        cursor.style.top = (y * 100) + '%';
        
        calculateAndSend(x, y);
    });

    pad.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function calculateAndSend(x, y) {
        if(Object.keys(baseParams).length === 0) return;
        let msg = "";

        Object.keys(baseParams).forEach(key => {
            if(CC_MAP[key]) {
                const baseVal = baseParams[key];
                let finalVal = baseVal;

                if (key === "Drive") {
                    finalVal = baseVal + ((0.5 - y) * 8.0);
                }
                if (key === "Presence" || key === "Treble") {
                    finalVal = baseVal + ((x - 0.5) * 4.0);
                }
                if (key === "ChVol" || key === "Master") {
                    finalVal = baseVal + ((x - 0.5) * 3.0);
                }

                let midiVal = Math.floor(finalVal * 12.7);
                midiVal = Math.max(0, Math.min(127, midiVal));

                if(midiOut) midiOut.send([0xB0, CC_MAP[key], midiVal]);
                
                if(key === "Drive") msg += `DRIVE: ${(midiVal/12.7).toFixed(1)}  `;
                if(key === "Presence") msg += `PRES: ${(midiVal/12.7).toFixed(1)}`;
            }
        });
        document.getElementById('status').innerText = msg;
    }
</script>
</body>
</html>
