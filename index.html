<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helix Focus - Modo 1 Preset</title>
    <style>
        body { 
            color: #e0e0e0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin: 0; 
            overflow: hidden; 
            background-color: #121212; 
            background-image: linear-gradient(rgba(18, 18, 18, 0.9), rgba(18, 18, 18, 0.9)), url('https://ortizo.com.co/cdn/shop/files/GS10372.jpg?v=1755619445&width=480');
            background-size: cover;
            background-position: center center;
        }
        h2 { margin: 10px 0; color: #ff9800; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Controles */
        .controls { display: flex; justify-content: center; gap: 10px; padding: 10px; }
        
        .file-btn { 
            background: #333; color: white; border: 1px solid #555; 
            padding: 10px 20px; border-radius: 8px; font-size: 0.85rem; 
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            width: 60%; justify-content: center;
        }
        .file-btn.loaded { background-color: #004d40; border-color: #00e676; }
        
        input[type="file"] { display: none; }
        
        /* Botones AcciÃ³n */
        .action-btn { border: none; padding: 10px 15px; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 0.8rem; margin: 5px; }
        #connect-btn { background: #00e676; color: black; width: 90%; }
        
        /* BotÃ³n MÃ¡gico */
        #magic-btn { 
            background: linear-gradient(45deg, #ff5722, #ff9100); 
            color: white; width: 90%; 
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
        }
        #magic-btn:active { transform: scale(0.98); }

        /* Pad */
        #pad-container {
            width: 90vw; height: 50vh; margin: 10px auto;
            background: radial-gradient(circle, #2c2c2c 0%, #1a1a1a 100%);
            border: 2px solid #ff9800; border-radius: 12px;
            position: relative; touch-action: none; 
        }
        #cursor {
            width: 40px; height: 40px; background: rgba(255, 152, 0, 0.8);
            border: 3px solid #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #ff9800;
        }

        /* Monitor */
        #status { font-family: monospace; font-size: 0.9rem; color: #00e676; margin-top: 5px; height: 80px; white-space: pre-wrap; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <h2>Helix Focus (Modo 1 Archivo)</h2>
    
    <button id="connect-btn" class="action-btn" onclick="initMIDI()">ðŸ”Œ 1. Conectar USB MIDI</button>

    <div class="controls">
        <label class="file-btn" id="lbl-tl">
            ðŸ“‚ 2. Cargar Preset Base
            <input type="file" onchange="loadBaseHlx(this)">
        </label>
    </div>
    
    <button id="magic-btn" class="action-btn hidden" onclick="generateVariations()">âœ¨ 3. Crear VariaciÃ³n AutomÃ¡tica</button>

    <div id="pad-container">
        <div id="cursor"></div>
    </div>

    <div id="status">Carga un archivo .hlx para empezar</div>

<script>
    const CC_MAP = {
        "Drive": 4,  "Bass": 5,   "Mid": 6, 
        "Treble": 7, "Presence": 8, "Master": 9,
        "ChVol": 10, "Mix": 11, "Decay": 12
    };

    let midiOut = null;
    // Ahora solo usamos Start (Inicio) y End (Fin) para simplificar
    let presetBase = {};
    let presetMax = {}; 

    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX") || o.name.includes("Line 6")) || outputs[0];
            
            if (midiOut) {
                document.getElementById('connect-btn').innerText = "âœ… Conectado: " + midiOut.name;
                document.getElementById('connect-btn').style.background = "#b9f6ca";
            } else { alert("No se encontrÃ³ pedal MIDI."); }
        } catch (e) { alert("Error MIDI: " + e); }
    }

    function loadBaseHlx(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                // Leer el archivo
                const str = JSON.stringify(JSON.parse(e.target.result));
                const params = {};
                
                Object.keys(CC_MAP).forEach(pName => {
                    const regex = new RegExp(`"${pName}":\\s*([0-9.]+)`, 'g');
                    const match = regex.exec(str);
                    if (match) params[pName] = parseFloat(match[1]);
                });

                if (Object.keys(params).length > 0) {
                    presetBase = params; // Guardamos el sonido original
                    document.getElementById('lbl-tl').classList.add('loaded');
                    document.getElementById('lbl-tl').innerHTML = `âœ… ${file.name.substring(0,15)}...`;
                    document.getElementById('magic-btn').classList.remove('hidden');
                    document.getElementById('status').innerText = "Archivo cargado. \nÂ¡Ahora pulsa el botÃ³n naranja!";
                } else {
                    document.getElementById('status').innerText = "Error: El preset no tiene parÃ¡metros Drive/Bass/Mid reconocibles.";
                }
            } catch (err) { alert("Archivo invÃ¡lido"); }
        };
        reader.readAsText(file);
    }

    function generateVariations() {
        if (Object.keys(presetBase).length === 0) return;

        // CLONAR Y MODIFICAR PARA CREAR EL PRESET "DESTINO"
        presetMax = { ...presetBase }; // Copia exacta
        
        // AquÃ­ ocurre la magia: Modificamos los valores virtualmente
        if(presetMax["Drive"] !== undefined) presetMax["Drive"] = 100; // Drive al mÃ¡ximo
        if(presetMax["Mid"] !== undefined) presetMax["Mid"] = Math.min(100, (presetMax["Mid"] || 50) + 30); // Subir medios
        if(presetMax["Bass"] !== undefined) presetMax["Bass"] = Math.max(0, (presetMax["Bass"] || 50) - 20); // Bajar bajos (corte)
        
        // Master y ChVol se quedan igual para no cambiar volumen drÃ¡sticamente
        
        document.getElementById('magic-btn').innerText = "âš¡ Â¡AUTO-MODO ACTIVADO! âš¡";
        document.getElementById('magic-btn').style.background = "#212121";
        document.getElementById('status').innerText = "Izquierda = Tu Preset Original\nDerecha = VersiÃ³n Turbo (Auto-generada)";
    }

    // --- INTERPOLACIÃ“N ---
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if (!e.isPrimary || (e.buttons === 0 && e.pointerType === 'mouse')) return;
        if (Object.keys(presetMax).length === 0) return; // Si no ha activado el modo mÃ¡gico, no hace nada

        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        x = Math.max(0, Math.min(1, x)); // 0 a 1

        cursor.style.left = (x * 100) + '%';
        cursor.style.top = '50%'; // Bloqueamos Y para hacerlo mÃ¡s fÃ¡cil (solo Izq-Der)
        
        processMidi(x);
    });
    
    // Evitar scroll en mÃ³vil
    pad.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function processMidi(x) {
        if (!midiOut) return;
        let logStr = "";

        Object.keys(presetBase).forEach(param => {
            if (CC_MAP[param]) {
                const startVal = presetBase[param]; // Valor Original
                const endVal = presetMax[param];   // Valor "Turbo" (Auto-generado)

                // Calcular valor intermedio
                const currentVal = startVal + (endVal - startVal) * x;
                const midiVal = Math.min(127, Math.max(0, Math.floor(currentVal * 127))); // Escala MIDI (0-127) de la Helix

                // IMPORTANTE: En Helix los valores internos suelen ser 0.0-1.0, pero MIDI es 0-127.
                // Si el preset dice "0.5", enviamos MIDI 64.
                // Si el parametro del JSON venÃ­a en formato 0-10, hay que ajustar. 
                // Asumimos que el JSON trae formato 0.0-1.0 (standard Helix).
                
                // Si el JSON trae valores enteros (ej: Drive: 5.0), la fÃ³rmula cambia.
                // Ajuste rÃ¡pido: Si detectamos valor > 1 en el original, asumimos escala 0-10
                let finalMidi = 0;
                if (startVal > 1.0) {
                     // Escala 0-10 (comÃºn en Helix Edit display, pero el JSON suele ser 0-1)
                     // Pero por seguridad, usaremos mapeo directo si parece MIDI.
                     finalMidi = Math.floor(currentVal * 12.7); 
                } else {
                     // Escala 0.0 - 1.0
                     finalMidi = Math.floor(currentVal * 127);
                }
                
                // CorrecciÃ³n de seguridad para no pasarse
                finalMidi = Math.min(127, Math.max(0, finalMidi));

                midiOut.send([0xB0, CC_MAP[param], finalMidi]);
                logStr += `${param}: ${finalMidi} \n`;
            }
        });
        document.getElementById('status').innerText = logStr;
    }
</script>
</body>
</html>
