<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helix Focus - Master</title>
    <style>
        body { 
            color: #e0e0e0; 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            margin: 0; 
            overflow: hidden; 
            background-color: #121212; 
            /* Fondo oscuro profesional */
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://ortizo.com.co/cdn/shop/files/GS10372.jpg?v=1755619445&width=480');
            background-size: cover;
            background-position: center;
        }

        h2 { margin: 10px 0; color: #ff9800; letter-spacing: 1px; }

        /* --- PAD XY (El Joystick) --- */
        #pad-container {
            width: 90vw; height: 45vh; margin: 10px auto;
            background: radial-gradient(circle, #333 0%, #111 100%);
            border: 2px solid #ff9800; border-radius: 12px;
            position: relative; touch-action: none; 
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.2);
        }
        #cursor {
            width: 40px; height: 40px; 
            background: rgba(255, 152, 0, 0.5);
            border: 3px solid #fff; border-radius: 50%;
            position: absolute; transform: translate(-50%, -50%);
            top: 50%; left: 50%; 
            pointer-events: none; /* Deja pasar el click al fondo */
            transition: background 0.2s;
        }
        #pad-container:active #cursor { background: rgba(255, 152, 0, 1); box-shadow: 0 0 15px #ff9800; }

        /* --- BOTONES DE CARGA --- */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        
        .file-btn { 
            background: #263238; color: #cfd8dc; border: 1px solid #455a64; 
            padding: 8px; border-radius: 6px; font-size: 0.8rem; 
            cursor: pointer; position: relative; display: flex; 
            justify-content: center; align-items: center; min-height: 40px;
        }
        
        /* Estilo cuando est√° cargado */
        .file-btn.loaded { 
            background-color: #1b5e20; /* Verde oscuro */
            border-color: #66bb6a; 
            color: #fff;
            justify-content: space-between; 
            padding-right: 35px; /* Espacio para la X */
        }

        /* --- BOT√ìN DE BORRAR (LA X) --- */
        .clear-x {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background: #b71c1c; color: white;
            border-radius: 50%; width: 24px; height: 24px;
            line-height: 24px; text-align: center; font-weight: bold;
            font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .clear-x:hover { background: #ff5252; transform: translateY(-50%) scale(1.1); }

        input[type="file"] { display: none; }

        /* --- BOTONES ACCI√ìN --- */
        .action-btn { 
            border: none; padding: 12px 20px; font-weight: bold; 
            border-radius: 25px; cursor: pointer; font-size: 0.9rem; width: 90%; margin: 5px; 
            text-transform: uppercase;
        }
        #connect-btn { background: #00e676; color: #000; box-shadow: 0 4px 10px rgba(0, 230, 118, 0.3); }
        #reset-btn { background: #d32f2f; color: white; width: auto; font-size: 0.7rem; padding: 5px 15px; }

        /* MONITOR */
        #status { 
            font-family: monospace; color: #69f0ae; margin-top: 10px; 
            height: 100px; white-space: pre-wrap; font-size: 0.85rem;
            background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; width: 90%; margin-left: auto; margin-right: auto;
        }
    </style>
</head>
<body>

    <h2>üéõÔ∏è Helix Focus Master</h2>
    <button id="connect-btn" class="action-btn" onclick="initMIDI()">üîå 1. Conectar USB MIDI</button>

    <div class="controls">
        <label class="file-btn">üìÇ A (Arriba-Izq)<input type="file" onchange="loadHlx(this, 'tl')"></label>
        <label class="file-btn">üìÇ B (Arriba-Der)<input type="file" onchange="loadHlx(this, 'tr')"></label>
        <label class="file-btn">üìÇ C (Abajo-Izq)<input type="file" onchange="loadHlx(this, 'bl')"></label>
        <label class="file-btn">üìÇ D (Abajo-Der)<input type="file" onchange="loadHlx(this, 'br')"></label>
    </div>

    <button id="reset-btn" class="action-btn" onclick="resetAll()">üóëÔ∏è Borrar Todo</button>

    <div id="pad-container">
        <div id="cursor"></div>
    </div>

    <div id="status">Esperando conexi√≥n...</div>

<script>
    // --- MAPA MIDI (Ajusta si usas otros CC) ---
    const CC_MAP = {
        "Drive": 4,  "Bass": 5,   "Mid": 6, 
        "Treble": 7, "Presence": 8, "Master": 9,
        "ChVol": 10, "Mix": 11, "Decay": 12
    };

    let midiOut = null;
    let corners = { tl: {}, tr: {}, bl: {}, br: {} };

    document.addEventListener('DOMContentLoaded', loadSessionFromStorage);

    // 1. CONEXI√ìN MIDI
    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            // Busca dispositivos Line 6 o usa el primero que encuentre
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX") || o.name.includes("Line 6")) || outputs[0];
            
            if (midiOut) {
                document.getElementById('connect-btn').style.background = "#2979ff";
                document.getElementById('connect-btn').style.color = "white";
                document.getElementById('connect-btn').innerText = "‚úÖ Conectado: " + midiOut.name;
                log("MIDI Listo: " + midiOut.name);
            } else { alert("No se detect√≥ ning√∫n pedal MIDI USB."); }
        } catch (e) { alert("Error al conectar MIDI: " + e); }
    }

    // 2. CARGA DE ARCHIVOS
    function loadHlx(input, key) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                // Truco para limpiar el JSON y buscar par√°metros
                const jsonStr = JSON.stringify(JSON.parse(e.target.result));
                const params = {};
                
                Object.keys(CC_MAP).forEach(pName => {
                    const regex = new RegExp(`"${pName}":\\s*([0-9.]+)`, 'g');
                    const match = regex.exec(jsonStr);
                    if (match) params[pName] = parseFloat(match[1]);
                });

                if (Object.keys(params).length > 0) {
                    corners[key] = params;
                    // Guardar en memoria
                    localStorage.setItem(`hFx_p_${key}`, JSON.stringify(params));
                    localStorage.setItem(`hFx_n_${key}`, file.name);
                    updateUI(key, file.name);
                    log(`Cargado ${key.toUpperCase()}: ${Object.keys(params).length} par√°metros.`);
                } else {
                    log(`‚ö†Ô∏è Error: El archivo ${file.name} no tiene params (Drive, Bass, etc).`);
                }
            } catch (err) { log("Error: Archivo inv√°lido."); }
        };
        reader.readAsText(file);
    }

    // 3. ACTUALIZAR BOTONES (Pone la X roja)
    function updateUI(key, fileName) {
        // Encontrar el label correcto buscando el input dentro
        const input = document.querySelector(`input[onchange="loadHlx(this, '${key}')"]`);
        const label = input.parentElement;

        if (fileName) {
            label.classList.add('loaded');
            const shortName = fileName.length > 10 ? fileName.substring(0, 9) + '..' : fileName;
            // Aqu√≠ inyectamos el HTML con la X roja
            label.innerHTML = `
                <span>‚úÖ ${shortName}</span>
                <div class="clear-x" onclick="clearSlot(event, '${key}')">‚úñ</div>
                <input type="file" onchange="loadHlx(this, '${key}')">
            `;
        } else {
            label.classList.remove('loaded');
            const names = {tl:'A (Arriba-Izq)', tr:'B (Arriba-Der)', bl:'C (Abajo-Izq)', br:'D (Abajo-Der)'};
            label.innerHTML = `üìÇ ${names[key]}<input type="file" onchange="loadHlx(this, '${key}')">`;
        }
    }

    // 4. BORRAR SLOT INDIVIDUAL
    function clearSlot(e, key) {
        e.stopPropagation(); // Evita que se abra el selector de archivos
        e.preventDefault();
        
        corners[key] = {};
        localStorage.removeItem(`hFx_p_${key}`);
        localStorage.removeItem(`hFx_n_${key}`);
        updateUI(key, null);
        log(`Slot ${key.toUpperCase()} borrado.`);
    }

    function resetAll() {
        if(!confirm("¬øBorrar todo?")) return;
        ['tl','tr','bl','br'].forEach(k => clearSlot({stopPropagation:()=>{}, preventDefault:()=>{}}, k));
    }

    // 5. MEMORIA (Recargar al abrir)
    function loadSessionFromStorage() {
        ['tl','tr','bl','br'].forEach(key => {
            const p = localStorage.getItem(`hFx_p_${key}`);
            const n = localStorage.getItem(`hFx_n_${key}`);
            if (p && n) {
                corners[key] = JSON.parse(p);
                updateUI(key, n);
            }
        });
    }

    // --- JOYSTICK LOGIC ---
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if (!e.isPrimary) return;
        // Si es mouse, debe estar clicado. Si es touch, siempre funciona.
        if (e.pointerType === 'mouse' && e.buttons === 0) return;

        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        let y = (e.clientY - rect.top) / rect.height;
        
        // Limites 0 a 1
        x = Math.max(0, Math.min(1, x));
        y = Math.max(0, Math.min(1, y));

        // Mover cursor visualmente
        cursor.style.left = (x * 100) + '%';
        cursor.style.top = (y * 100) + '%';

        // Enviar datos
        processMidi(x, y);
    });

    pad.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function processMidi(x, y) {
        // TRUCO: Si no hay MIDI conectado, igual mostramos los n√∫meros en pantalla para verificar
        // Solo salimos si no hay ning√∫n archivo cargado en 'tl' (A)
        if (Object.keys(corners.tl).length === 0) return;

        let logStr = "";
        
        // Iterar sobre los par√°metros del archivo A
        Object.keys(corners.tl).forEach(param => {
            if (CC_MAP[param]) {
                // VALORES:
                // Si la esquina B, C o D est√° vac√≠a, usamos el valor de A (tl) como respaldo.
                // Esto permite que funcione cargando solo 1 archivo.
                const vTL = corners.tl[param]; 
                const vTR = corners.tr[param] !== undefined ? corners.tr[param] : vTL;
                const vBL = corners.bl[param] !== undefined ? corners.bl[param] : vTL;
                const vBR = corners.br[param] !== undefined ? corners.br[param] : vTR; // Si falta D, usa B o A

                // Interpolaci√≥n Bilineal
                const topVal = vTL + (vTR - vTL) * x;
                const botVal = vBL + (vBR - vBL) * x;
                const finalVal = topVal + (botVal - topVal) * y;

                // Convertir a MIDI (0-127)
                const midiVal = Math.floor(Math.min(127, Math.max(0, finalVal * 127)));

                // Enviar al pedal (si est√° conectado)
                if (midiOut) midiOut.send([0xB0, CC_MAP[param], midiVal]);
                
                logStr += `${param}: ${midiVal}  `;
            }
        });
        
        document.getElementById('status').innerText = logStr;
    }

    function log(msg) { document.getElementById('status').innerText = msg; }
</script>
</body>
</html>
