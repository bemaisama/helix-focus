<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helix Focus - VibroVerb Edition</title>
    <style>
        body { 
            background-color: #1a1a1a; color: #fff; 
            font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; overflow: hidden;
        }
        
        h2 { color: #ff5722; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px;}
        
        /* El Joystick */
        #pad-container {
            width: 90vw; height: 55vh; margin: 15px auto;
            /* Fondo con gradiente visual para guiarte */
            background: linear-gradient(to bottom, #4e342e 0%, #263238 100%);
            border: 3px solid #ff5722; border-radius: 15px;
            position: relative; touch-action: none;
            box-shadow: 0 0 25px rgba(255, 87, 34, 0.2);
        }
        
        /* L√≠neas gu√≠a del centro */
        #pad-container::after {
            content: ""; position: absolute; top: 50%; left: 0; right: 0; border-top: 1px dashed rgba(255,255,255,0.2); pointer-events: none;
        }
        #pad-container::before {
            content: ""; position: absolute; left: 50%; top: 0; bottom: 0; border-left: 1px dashed rgba(255,255,255,0.2); pointer-events: none;
        }

        #cursor {
            width: 50px; height: 50px; background: rgba(255, 87, 34, 0.7);
            border: 3px solid #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none; box-shadow: 0 0 15px #ff5722;
        }

        /* Botones */
        .btn { 
            padding: 12px; border-radius: 8px; border: none; 
            font-weight: bold; margin: 5px; cursor: pointer; width: 85%;
            font-size: 0.9rem; text-transform: uppercase;
        }
        .btn-connect { background: #00e676; color: #000; }
        .btn-file { background: #37474f; color: #fff; border: 1px solid #546e7a; }
        .btn-file.loaded { background: #ff5722; border-color: #ffab91; color: white; }
        
        input[type="file"] { display: none; }
        
        /* Texto de estado */
        #status { 
            font-family: monospace; color: #00e676; 
            background: #000; padding: 10px; width: 90%; 
            margin: 0 auto; border-radius: 5px;
            font-size: 0.8rem; line-height: 1.4;
        }
    </style>
</head>
<body>

    <h2>üéõÔ∏è MODO VIBRO-VERB</h2>
    
    <button class="btn btn-connect" id="btn-con" onclick="initMIDI()">üîå 1. Conectar HX Stomp</button>
    
    <label class="btn btn-file" id="lbl-file">
        üìÇ 2. Cargar JM Vibro Verb.hlx
        <input type="file" onchange="loadFile(this)">
    </label>

    <div id="pad-container">
        <div id="cursor"></div>
    </div>

    <div id="status">Esperando archivo...</div>

<script>
    // Mapa MIDI est√°ndar de Helix
    const CC_MAP = { "Drive": 4, "Bass": 5, "Mid": 6, "Treble": 7, "Presence": 8, "ChVol": 10, "Master": 9 };
    let midiOut = null;
    let baseParams = {}; 

    // 1. CONEXI√ìN MIDI
    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX") || o.name.includes("Line 6")) || outputs[0];
            if(midiOut) {
                document.getElementById('btn-con').innerText = "‚úÖ CONECTADO: " + midiOut.name;
                document.getElementById('btn-con').style.background = "#b9f6ca";
            }
        } catch(e) { alert("Error MIDI: " + e); }
    }

    // 2. LEER TU ARCHIVO
    function loadFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const txt = e.target.result;
            // Extraer par√°metros base de tu archivo
            Object.keys(CC_MAP).forEach(k => {
                const regex = new RegExp(`"${k}":\\s*([0-9.]+)`);
                const match = regex.exec(txt);
                if(match) baseParams[k] = parseFloat(match[1]);
            });

            if(Object.keys(baseParams).length > 0) {
                document.getElementById('lbl-file').classList.add('loaded');
                document.getElementById('lbl-file').innerHTML = `‚úÖ ${file.name.substring(0,20)}`;
                document.getElementById('status').innerText = "¬°LISTO! Mueve el punto:\n‚¨ÜÔ∏è Arriba: Crunch | ‚¨áÔ∏è Abajo: Clean\n‚û°Ô∏è Derecha: Potencia | ‚¨ÖÔ∏è Izquierda: Suave";
            } else {
                alert("Error: No encontr√© par√°metros de Amplificador en este archivo.");
            }
        };
        reader.readAsText(file);
    }

    // 3. LOGICA MATEM√ÅTICA "SUPER VIB"
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if(!e.isPrimary) return;
        if(e.pointerType === 'mouse' && e.buttons === 0) return; 

        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        let y = (e.clientY - rect.top) / rect.height;
        
        // Limitar entre 0 y 1
        x = Math.max(0, Math.min(1, x));
        y = Math.max(0, Math.min(1, y));

        cursor.style.left = (x * 100) + '%';
        cursor.style.top = (y * 100) + '%';
        
        calculateAndSend(x, y);
    });

    // Para m√≥viles
    pad.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function calculateAndSend(x, y) {
        if(Object.keys(baseParams).length === 0) return;
        let msg = "";

        Object.keys(baseParams).forEach(key => {
            if(CC_MAP[key]) {
                const baseVal = baseParams[key]; // Valor original del archivo (Centro)
                let finalVal = baseVal;

                // --- L√ìGICA DE TRANSFORMACI√ìN ---
                
                // 1. DRIVE: Controlado por Y (Arriba=0, Abajo=1)
                // Arriba (0) suma hasta +4.0 de ganancia. Abajo (1) resta hasta -4.0 (Clean)
                if (key === "Drive") {
                    const modifier = (0.5 - y) * 8.0; // Rango de +/- 4.0
                    finalVal = baseVal + modifier;
                }

                // 2. PRESENCE y TREBLE: Controlado por X (Der=1, Izq=0)
                // Derecha da m√°s brillo/presencia. Izquierda lo mantiene suave.
                if (key === "Presence" || key === "Treble") {
                    const modifier = (x - 0.5) * 4.0; // Rango de +/- 2.0
                    finalVal = baseVal + modifier;
                }

                // 3. MASTER / CH VOL: Controlado por X (Potencia)
                // Derecha da un empuj√≥n de volumen ("Potencia")
                if (key === "ChVol" || key === "Master") {
                    const modifier = (x - 0.5) * 3.0; // Un poco m√°s de volumen a la derecha
                    finalVal = baseVal + modifier;
                }

                // --- ENV√çO MIDI ---
                // Convertir valor 0.0-10.0 a MIDI 0-127
                let midiVal = Math.floor(finalVal * 12.7);
                
                // Seguridad: Limitar entre 0 y 127
                midiVal = Math.max(0, Math.min(127, midiVal));

                if(midiOut) midiOut.send([0xB0, CC_MAP[key], midiVal]);
                
                // Mostrar en pantalla (Decodificado a 0-10 para que lo entiendas)
                const displayVal = (midiVal / 12.7).toFixed(1);
                if(key === "Drive" || key === "Presence") {
                    msg += `${key}: ${displayVal}  `;
                }
            }
        });
        document.getElementById('status').innerText = msg;
    }
</script>
</body>
</html>
