<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Helix Focus Controller</title>
    <style>
        body { 
            color: #e0e0e0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin: 0; 
            overflow: hidden;
            background-color: #121212; 
            background-image: linear-gradient(rgba(18, 18, 18, 0.85), rgba(18, 18, 18, 0.85)), url('https://ortizo.com.co/cdn/shop/files/GS10372.jpg?v=1755619445&width=480');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        h2 { margin: 10px 0; color: #ff5722; }
        
        /* Controles de carga */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        
        .file-btn { 
            background: #333; color: white; border: 1px solid #555; 
            padding: 10px; border-radius: 8px; font-size: 0.8rem; 
            cursor: pointer; transition: background-color 0.3s, border-color 0.3s;
            display: flex; justify-content: center; align-items: center; gap: 5px;
            position: relative;
        }
        .file-btn.loaded { background-color: #004d40; border-color: #00e676; justify-content: space-between; }
        
        /* Bot√≥n de borrar individual (X) */
        .clear-x {
            background: rgba(0,0,0,0.3);
            color: #ff5722;
            border-radius: 50%;
            width: 20px; height: 20px;
            line-height: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            z-index: 10;
        }
        .clear-x:hover { background: #ff5722; color: white; }

        input[type="file"] { display: none; }
        
        /* Botones Generales */
        .action-btn { border: none; padding: 10px 20px; font-weight: bold; border-radius: 20px; margin: 5px; cursor: pointer; }
        #connect-btn { background: #00e676; color: black; }
        #reset-all-btn { background: #d32f2f; color: white; font-size: 0.8rem; width: 90%; margin: 0 auto; display: block;}

        /* El Pad XY */
        #pad-container {
            width: 90vw; height: 45vh; margin: 10px auto;
            background: radial-gradient(circle, #2c2c2c 0%, #1a1a1a 100%);
            border: 2px solid #ff5722; border-radius: 12px;
            position: relative; touch-action: none; 
        }
        #cursor {
            width: 30px; height: 30px; background: rgba(255, 87, 34, 0.8);
            border: 2px solid #fff; border-radius: 50%;
            position: absolute; transform: translate(-50%, -50%);
            top: 50%; left: 50%; box-shadow: 0 0 15px #ff5722;
        }

        /* Monitor de datos */
        #status { font-family: monospace; font-size: 0.9rem; color: #00e676; margin-top: 5px; white-space: pre-wrap; height: 80px; overflow-y: auto; }
    </style>
</head>
<body>

    <h2>Helix Focus View</h2>
    <button id="connect-btn" class="action-btn" onclick="initMIDI()">üîå Conectar USB MIDI</button>

    <div class="controls">
        <label class="file-btn" id="lbl-tl">üìÇ A (Top-L)<input type="file" onchange="loadHlx(this, 'tl')"></label>
        <label class="file-btn" id="lbl-tr">üìÇ B (Top-R)<input type="file" onchange="loadHlx(this, 'tr')"></label>
        <label class="file-btn" id="lbl-bl">üìÇ C (Bot-L)<input type="file" onchange="loadHlx(this, 'bl')"></label>
        <label class="file-btn" id="lbl-br">üìÇ D (Bot-R)<input type="file" onchange="loadHlx(this, 'br')"></label>
    </div>
    
    <button id="reset-all-btn" class="action-btn" onclick="resetAll()">üóëÔ∏è Borrar Todos los Presets</button>

    <div id="pad-container">
        <div id="cursor"></div>
    </div>

    <div id="status">Esperando conexi√≥n...</div>

<script>
    const CC_MAP = {
        "Drive": 4,  "Bass": 5,   "Mid": 6, 
        "Treble": 7, "Presence": 8, "Master": 9,
        "ChVol": 10, "Mix": 11, "Decay": 12
    };

    let midiOut = null;
    let corners = { tl: {}, tr: {}, bl: {}, br: {} };

    document.addEventListener('DOMContentLoaded', loadSessionFromStorage);

    // 1. INICIALIZAR MIDI
    async function initMIDI() {
        try {
            const access = await navigator.requestMIDIAccess();
            const outputs = Array.from(access.outputs.values());
            midiOut = outputs.find(o => o.name.includes("Helix") || o.name.includes("HX") || o.name.includes("Line 6"));
            if (!midiOut && outputs.length > 0) midiOut = outputs[0];
            
            if (midiOut) {
                document.getElementById('connect-btn').style.background = "#2196F3";
                document.getElementById('connect-btn').innerText = "‚úÖ " + midiOut.name;
                log("Conectado a: " + midiOut.name);
            } else {
                alert("No se encontr√≥ pedal MIDI.");
            }
        } catch (e) { alert("Error MIDI: " + e); }
    }

    // 2. LEER ARCHIVOS .HLX
    function loadHlx(input, key) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                const str = JSON.stringify(json);
                const params = {};
                
                Object.keys(CC_MAP).forEach(pName => {
                    const regex = new RegExp(`"${pName}":\\s*([0-9.]+)`, 'g');
                    const match = regex.exec(str);
                    if (match) params[pName] = parseFloat(match[1]);
                });

                if (Object.keys(params).length > 0) {
                    corners[key] = params;
                    localStorage.setItem(`helixFocus_params_${key}`, JSON.stringify(params));
                    localStorage.setItem(`helixFocus_fileName_${key}`, file.name);
                    updateCornerUI(key, file.name);
                    log(`Cargado ${key.toUpperCase()}: ${file.name}`);
                } else {
                    log(`Error: Sin par√°metros v√°lidos en ${file.name}`);
                }
            } catch (err) { log("Error leyendo archivo."); }
        };
        reader.readAsText(file);
    }

    // 3. ACTUALIZAR UI (con bot√≥n de borrar individual)
    function updateCornerUI(key, fileName) {
        // Buscamos el label padre del input espec√≠fico
        const input = document.querySelector(`input[onchange="loadHlx(this, '${key}')"]`);
        const label = input.parentElement;
        
        if (fileName) {
            label.classList.add('loaded');
            const displayName = fileName.length > 15 ? fileName.substring(0, 12) + '...' : fileName;
            
            // Inyectamos el HTML con el nombre y la X. 
            // IMPORTANTE: el onclick de la X tiene stopPropagation para no abrir el selector de archivos
            label.innerHTML = `
                <span>‚úÖ ${displayName}</span>
                <span class="clear-x" onclick="clearCorner(event, '${key}')">‚úñ</span>
                <input type="file" onchange="loadHlx(this, '${key}')">
            `;
        } else {
            label.classList.remove('loaded');
            const cornerName = {tl: 'A (Top-L)', tr: 'B (Top-R)', bl: 'C (Bot-L)', br: 'D (Bot-R)'}[key];
            label.innerHTML = `üìÇ Cargar ${cornerName}<input type="file" onchange="loadHlx(this, '${key}')">`;
        }
    }

    // 4. NUEVAS FUNCIONES DE RESET
    function clearCorner(e, key) {
        // Evita que el click abra el explorador de archivos
        e.preventDefault();
        e.stopPropagation();

        corners[key] = {};
        localStorage.removeItem(`helixFocus_params_${key}`);
        localStorage.removeItem(`helixFocus_fileName_${key}`);
        updateCornerUI(key, null);
        log(`Preset ${key.toUpperCase()} desmontado.`);
    }

    function resetAll() {
        if(!confirm("¬øSeguro que quieres borrar todas las cargas?")) return;
        ['tl', 'tr', 'bl', 'br'].forEach(key => {
            corners[key] = {};
            localStorage.removeItem(`helixFocus_params_${key}`);
            localStorage.removeItem(`helixFocus_fileName_${key}`);
            updateCornerUI(key, null);
        });
        log("Todos los presets han sido borrados.");
    }

    // 5. CARGAR SESI√ìN
    function loadSessionFromStorage() {
        ['tl', 'tr', 'bl', 'br'].forEach(key => {
            const paramsStr = localStorage.getItem(`helixFocus_params_${key}`);
            const fileName = localStorage.getItem(`helixFocus_fileName_${key}`);
            if (paramsStr && fileName) {
                corners[key] = JSON.parse(paramsStr);
                updateCornerUI(key, fileName);
            }
        });
    }

    // 6. INTERPOLACI√ìN (Pad)
    const pad = document.getElementById('pad-container');
    const cursor = document.getElementById('cursor');

    pad.addEventListener('pointermove', (e) => {
        if (!e.isPrimary) return; 
        if (e.buttons === 0 && e.pointerType === 'mouse') return;
        
        const rect = pad.getBoundingClientRect();
        let x = (e.clientX - rect.left) / rect.width;
        let y = (e.clientY - rect.top) / rect.height;
        x = Math.max(0, Math.min(1, x));
        y = Math.max(0, Math.min(1, y));

        cursor.style.left = (x * 100) + '%';
        cursor.style.top = (y * 100) + '%';

        processMidi(x, y);
    });

    pad.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function processMidi(x, y) {
        if (!midiOut) return; // Permitir mover el cursor aunque no haya midi, pero no procesar

        let logStr = "";
        // Usamos TL como referencia de qu√© par√°metros existen
        const params = Object.keys(corners.tl).length > 0 ? Object.keys(corners.tl) : 
                      (Object.keys(corners.tr).length > 0 ? Object.keys(corners.tr) : []); // Fallback simple

        if (params.length === 0) return;

        params.forEach(param => {
            if (CC_MAP[param]) {
                const vTL = corners.tl[param] || 0;
                const vTR = corners.tr[param] || vTL; // Si falta una esquina, usa TL como base
                const vBL = corners.bl[param] || vTL;
                const vBR = corners.br[param] || vTL;

                const top = vTL + (vTR - vTL) * x;
                const bottom = vBL + (vBR - vBL) * x;
                const val = top + (bottom - top) * y;

                const midiVal = Math.min(127, Math.max(0, Math.floor(val * 127)));
                midiOut.send([0xB0, CC_MAP[param], midiVal]);
                logStr += `${param}: ${midiVal} \n`;
            }
        });
        if(logStr) document.getElementById('status').innerText = logStr;
    }

    function log(msg) { document.getElementById('status').innerText = msg; }
</script>
</body>
</html>
